/*
 * Copyright (c) 2021 Arm Limited and Contributors. All rights reserved.
 *
 * SPDX-License-Identifier: Apache-2.0
 * 
 * 
 * This examples captures data from an analog microphone using a sample
 * rate of 8 kHz and prints the sample values over the USB serial
 * connection.
 */
#include <stdio.h>
#include "edge-impulse-sdk/classifier/ei_run_classifier.h"
#include "pico/stdlib.h"
#include "analog_microphone.h"
#include "analog_microphone.c"
#include "tusb.h"
#include <ctime>
#include <iostream>

char ssid[] = "";
char pass[] = "";

// configuration
#define INSIZE 1024
const struct analog_microphone_config config = {
    // GPIO to use for input, must be ADC compatible (GPIO 26 - 28)
    .gpio = 26,

    // bias voltage of microphone in volts
    .bias_voltage = 1.25,

    // sample rate in Hz
    .sample_rate = 16000,

    // number of samples to buffer
    .sample_buffer_size = INSIZE,
};

// variables
int16_t sample_buffer[INSIZE];
volatile int samples_read = 0;

float features[10800];

const int minutes = .3;
const int threshold = 10;
const float thresh = 0.9;

int count_label_on = 0;
std::time_t start_time = std::time(0);

void on_analog_samples_ready() {
    // callback from library when all the samples in the library
    // internal sample buffer are ready for reading 
    samples_read = analog_microphone_read(sample_buffer, INSIZE);
}

static const float features_[] = {
    // copy raw features here (for example from the 'Live classification' page)

    //OFF
    //-318, -35, -33, -683, -77, -16, -5, -134, -269, -234, -159, -128, -161, -44, -9, 129, 98, 226, 291, 277, 382, 290, 242, 468, 341, 418, -190, 357, 136, 179, 132, 26, 134, 137, 231, -30, 4, -7, -64, -127, -92, -71, -254, -154, -178, -248, -82, -214, -319, -442, -563, -159, -80, 81, -1, -39, -59, 231, 95, 127, 187, 35, 319, 287, 148, 268, -105, 31, 319, 243, 432, 349, 122, 357, 41, 163, 199, 158, -89, -23, -106, -106, -140, -357, -375, -725, -555, -226, -74, 118, -66, -13, -10, -158, -2, -257, -351, -501, -577, 26, 151, 157, -141, 266, 254, 385, 299, 287, 461, 331, 372, 330, -122, 365, -49, 20, 33, 146, -35, -44, 32, -154, -192, 75, -628, -173, 82, -114, 43, -70, -275, -379, -385, -711, -202, -253, -84, 19, 13, 94, 106, 109, 398, 310, 326, 220, 157, 101, 269, -155, 0, 202, -30, 70, 122, 359, 29, 111, 201, -353, 138, -190, 252, 37, -13, 22, -287, -282, -513, -438, -186, -278, -301, -92, -66, 52, -633, -126, -42, -16, 28, -187, 35, -494, -37, 71, -324, 2, -339, 218, -25, 301, 331, 465, 355, 581, 493, 434, 107, 262, 174, 102, -112, -211, -179, -188, -65, -71, -260, -178, 71, -27, -50, -126, -134, -230, -166, -210, -187, -388, -308, -242, -102, -187, 133, 154, -379, 205, 481, 308, 116, 373, 274, 283, 221, 128, 175, 343, 269, 62, -59, -141, -256, 122, 133, -1, 94, -121, 77, 17, -365, -617, -405, -383, -338, -394, -221, -300, -247, -43, -112, -1, 36, -7, 5, 306, 102, -49, -42, 92, 166, 379, 197, 92, 135, 111, 222, 325, 187, 406, 382, 459, 481, -250, 110, 73, -54, -150, -32, -305, -166, -558, -335, -296, -172, -165, -122, -84, -86, -129, -96, -64, 14, -33, -86, -223, -125, -701, 119, 83, -474, 290, 377, 435, 445, 388, 486, 575, 310, 422, 374, 169, 265, 263, 97, 35, 46, 7, -55, -63, -38, -5, 41, 26, -326, -157, -183, -192, -215, -359, -449, -435, -420, -355, -193, -298, 42, 68, 32, 333, 451, 186, 298, 306, 57, 216, 151, 26, 66, -110, 138, 123, 263, 318, 422, 510, 429, 303, 381, 229, 15, 83, -586, -166, -104, -111, -148, -98, -259, -113, -324, -646, -78, -62, 107, 41, 66, -16, -535, -34, -171, -97, -126, 6, -16, 82, 171, -353, 237, 335, -242, 434, 455, 417, 492, 518, 324, 252, 87, -55, -593, -68, -374, -123, -170, -94, -50, -181, -123, 47, 99, 38, -127, -161, -205, -260, -267, -153, -51, -162, -49, -115, 33, 1, 171, -274, -24, -212, 329, 506, 340, 162, -221, 244, 147, 102, 12, -89, 133, 133, 310, 256, 408, 334, -101, -51, -148, -36, -61, -56, -164, -262, -388, -299, -339, -361, -320, -270, -89, -47, 70, 227, 133, 46, 8, 145, 183, 138, 86, 137, -93, 28, 279, 243, 226, 71, 512, 225, 532, 380, 275, 155, 151, 20, 0, -53, -305, -15, -160, -127, -15, -92, -157, -109, -272, -643, -51, -73, -105, -213, -42, -215, -213, -163, -114, -67, -29, -2, 79, 41, 243, 329, 238, 260, 379, 412, 365, 505, 329, 270, 209, 194, 115, 40, 106, 94, 49, 93, 107, 125, -27, 30, 99, -155, -52, -92, -108, -132, -359, -359, -330, -351, -283, -158, -198, -12, -516, 261, 284, 441, 370, 190, 324, 156, 113, 198, 51, -37, 53, 116, 231, 334, 210, 527, -189, 502, 101, 258, 277, 298, -81, 4, -218, -157, -164, -251, -246, -181, -131, -53, -43, -83, -191, -83, -404, -34, -111, -190, -20, -162, 12, -59, 170, 140, 101, 289, 133, -162, 324, 293, 315, 508, 268, 333, 335, -337, 123, 14, -389, -287, -525, 25, 134, 30, 131, 74, -217, 49, -117, -61, -237, -435, -253, -167, -141, -257, -424, -274, -332, 98, -16, -158, 113, 161, 92, 148, 275, 337, 294, 157, 186, 282, 292, 233, 275, 166, 201, 201, 181, 155, -117, 240, 68, 233, -74, -14, -141, -26, -86, -91, -168, -249, -171, -50, -295, -223, -328, -59, 57, -29, 59, 15, -132, 38, -231, 60, 33, 197, 131, 27, 350, 138, 286, 145, 20, 194, 446, 466, 577, 490, 443, 377, -381, -31, -122, -12, -284, -233, -260, 6, -141, -91, -598, -105, -27, -158, -126, -149, -275, -39, -50, -419, -227, -283, -174, -139, -16, -15, 274, 210, 326, 401, 509, 338, 369, -65, 345, 315, 179, 191, 343, 142, 147, 118, 73, 70, 114, 107, 145, 13, 116, 23, -37, -109, -822, -329, -491, -377, -333, -323, -301, -219, -23, -345, -381, -143, 107, 78, 147, 177, 73, 107, 95, 292, 173, 178, 243, 287, 372, 249, 374, 383, 365, 400, 506, 294, -326, 225, 105, 87, -76, -214, -320, -137, -213, -17, -111, -226, -255, -204, -195, 54, -109, 37, -282, -166, -57, -214, 27, 52, 22, 123, 13, -298, -287, 178, 221, 310, 574, 359, 449, 353, 459, 301, 268, 349, 220, 142, 143, 10, 104, -193, -496, -458, -412, -126, -110, -50, -16, 66, -20, 5, -108, -213, -345, -358, -245, -279, -147, -101, -45, -46, 139, -529, -80, 234, 423, 452, 258, 475, 329, -190, 174, 123, -17, 31, -44, -183, 30, -421, 183, -191, 219, 109, -194, -16, -16, -182, -156, -222, -263, -327, -482, -785, -805, -390, -700, 27, 69, 220, -539, 254, 301, 147, 205, -5, -89, 93, 193, 342, 181, 212, 190, 464, 365, 442, 470, 468, 206, 331, 270, 173, -86, -6, -90, -319, -870, -521, -210, -93, -132, -68, -65, -188, -170, -16, -163, -806, -258, -224, -210, -50, -111, -667, 7, 180, 179, 283, 163, 293, 458, 380, 358, 351, -255, 511, 279, 266, 217, 286, 164, 139, 47, 118, 118, 13, -541, -62, 81, -114, -199, 9, -71, -182, -114, -177, -173, -269, -332, -189, -126, -234, -57, -26, 12, 51, -12, 61, 71, 187, 298, 380, 175, 207, 173, 124, -52, 379, 350, 234, 212, 150, 98, -255, 13, 188, 175, 150, 175, 150, -540, -205, -228, -420, -212, -170, -312, -425, -346, -265, -402, -658, -179, -20, -221, 457, 220, 117, 23, -16, -41, -4, -21, 37, 181, 95, 213, 318, 479, 540, 435, 599, 508, 450, 417, 307, -257, -105, -153, -227, -166, -92, -113, -76, -257, -23, -516, -34, 95, -355, 96, -103, -177, -205, -379, -309, -203, -124, -281, -283, 6, 301, 319, 463, 263, -73, 483, 163, 151, 362, 223, 277, 132, 127, 117, 189, 230, 138, 158, 236, 53, 65, 28, -539, -390, -222, -145, -390, -350, -837, -603, -447, -242, -145, -211, -83, -35, 28, -55, -82, 122, -23, 58, 35, 117, 161, 156, -49, 286, 338, 349, 371, 345, 250, 332, 240, 337, 288, 262, -165, 54, 30, -23, 91, -131, -69, -154, -181, -204, -250, -110, -149, -302, -391, -196, -26, -81, 33, -431, -65, -202, -60, -16, -23, 181, 253, 286, 206, 327, 333, 334, 240, 246, -143, 397, 303, -188, 27, 119, 234, -16, 151, 168, 84, -41, 78, -169, -71, -16, -149, 10, -44, -139, -53, -235, -306, -277, -225, -374, -306, -236, -274, -117, 47, 133, 102, 5, 174, 464, 331, 37, 58, 212, 221, 172, 150, -45, 28, 222, 156, 303, 301, 231, 156, 492, 261, 202, 45, -297, -16, -348, -205, -355, -307, -339, -317, -266, -237, 119, -51, -16, 98, 49, 53, -4, -370, 15, -52, 44, -114, 94, -41, 176, 234, 17, 243, 327, 380, 364, 420, 471, 537, 252, 243, 222, -110, -609, -231, -113, -116, -332, 26, -221, 97, 108, -211, 91, -24, -271, -117, -272, -87, -751, -290, -521, -146, -189, -49, 177, 86, 121, 48, 132, -164, 33, 227, 230, 146, 396, 309, 400, 282, 143, -247, 10, 130, -359, 86, -10, 58, -116, -253, -16, -106, -179, -126, -106, -126, -272, -280, -197, -286, -94, -108, -51, -172, -46, -316, 113, 149, 55, 127, 130, 199, 147, -137, 366, 379, 324, 291, 262, 123, 107, 173, 173, 74, 263, 116, 207, 119, -398, -173, -29, -213, -32, -679, -222, -214, -93, -148, -27, -167, -262, -781, -178, -117, -29, 11, 128, -78, -54, -304, -104, 113, 98, 130, 298, 306, 442, 361, 249, 431, 554, 382, 350, 292, 141, 265, 206, -502, 47, 4, -71, -87, -29, -112, -65, -67, -91, -201, 63, -49, -306, -164, -909, -621, -205, -228, -261, -12, -237, 18, -35, 229, 191, 13, 265, 337, 343, 365, 261, 302, 213, 178, 189, 225, 171, 372, 330, 386, 182, 39, 168, 173, 137, -9, -143, -346, -317, -286, -299, -329, -278, -327, -128, -343, -142, -90, -30, 2, -375, -407, -243, -149, 46, 17, -12, -351, 55, 94, 20, 122, -6, 226, 323, 375, 484, 556, 468, 151, 315, -161, -6, 59, -87, -563, 6, -611, -58, -29, -4, -31, -83, -31, -156, -17, -137, -108, -141, -254, -457, -306, -85, -183, -97, -423, -53, 217, 134, 29, 172, 302, 394, 410, 309, 187, 123, 169, 113, 151, 193, 236, 194, 223, 198, 67, 162, -277, -125, -86, -19, -28, 114, -130, -16, -104, -21, -289, -289, -308, -625, -499, -36, -16, 33, -95, 43, -338, 145, 73, 122, 2, 188, 202, 162, 116, 99, 199, -77, -11, 366, 236, 180, 298, 271, 214, 41, 165, 136, 130, 106, -107, -65, -757, -90, -275, -254, -416, -276, -291, -149, -88, -81, 35, -4, -22, 5, -83, -140, 156, -100, -418, -141, 129, 143, 282, 327, 455, -52, 401, 506, 473, 446, 431, 441, -127, 164, -150, -765, 37, -662, -143, -13, -97, -130, -6, 182, 27, 73, 103, -137, -307, -844, -197, -300, -409, -411, -369, -158, 93, -82, -22, 74, 334, 379, 446, 354, 149, 521, 243, 246, 11, 20, 181, 154, 195, -97, -82, -423, 474, 190, 124, 371, 382, 308, 205, -22, -131, -379, -1153, -655, -505, -265, -361, -108, -195, -45, -114, 34, 105, -21, 76, -380, -217, -67, 21, 10, -6, -89, -85, -292, 215, 170, 436, 591, 487, 470, 442, 377, 356, 246, 177, -25, -411, -126, -94, -189, -165, -177, -212, -123, -15, 231, 65, 6, -50, -121, -196, -241, -284, -228, -239, -273, -163, -251, -153, -200, 249, 220, 337, 243, 431, 429, 324, 391, 271, 144, 123, 5, -483, 189, 198, 339, 287, 139, 341, -51, 154, 28, -53, -76, -565, -85, 5, -140, -106, -159, -78, -384, -387, -335, -147, -158, 165, 185, 162, 343, 471, 377, 175, 181, 93, 98, 77, 18, 76, 45, 66, 127, 299, 327, 492, 433, 487, 358, 464, 180, 263, 145, -37, -210, -835, -316, -119, -269, -244, -115, 13, -114, -16, -37, -76, -16, 9, -177, -16, -54, -27, -241, -251, -89, -26, 25, 192, 206, 198, 354, 327, 369, 417, 475, 455, 462, 287, 363, 230, -532, -401, -217, 7, -124, 71, 19, 98, 131, 198, 13, 12, -79, -65, -121, -204, -372, -318, -429, -383, -463, -290, -223, -42, 27, 104, 198, 189, 361, 475, 267, 286, 37, 361, 146, 209, 109, 79, -228, 148, -66, 339, 457, 370, 374, 517, 367, 363, 124, 4, -23, -21, -190, -333, -687, -297, -406, -421, -425, -222, -137, -92, 71, 36, -309, -59, 123, 90, 107, -84, -16, -16, -16, 97, 17, -65, -374, -68, 251, 531, 591, 687, 510, 525, 204, -67, 309, 83, -71, -287, -379, -363, -817, -274, -137, -51, -3, -26, 103, 42, 67, 84, -16, -229, -229, -237, -454, -409, -499, -330, -350, -12, -71, 455, 569, 559, 197, 588, 622, 542, 255, 194, 78, 131, -89, -256, 6, 86, -44, 152, 202, -67, 249, -306, 252, 149, 222, 100, -211, -306, -886, -935, -428, -478, -444, -255, -271, -420, 149, 211, 310, 393, 385, 446, 183, 260, 66, 28, 30, -58, -82, 25, 38, 199, 228, 508, 243, 467, 601, 500, 442, 341, 162, -17, -486, -278, -286, -372, -464, -335, -248, -186, -303, 31, 7, 1, 126, -61, 7, 68, -113, -77, -50, -298, -171, -14, -9, -495, 5, 162, 131, 331, 398, 544, 599, 629, 581, 435, 334, 349, 162, -106, -67, -34, -158, -70, -166, -254, -43, 105, 127, 102, 108, 117, -631, -485, -347, -350, -426, -249, -249, -388, -181, -103, -133, 163, 205, 315, 373, 316, 466, 402, 322, 329, 161, 132, 88, -292, 54, 11, -261, 183, 282, 217, 241, 213, 283, 203, 63, 57, 20, -181, -351, -235, -126, -350, -275, -293, -313, -229, -461, -5, -33, 39, 23, 20, 61, 132, 242, -16, 41, -367, 60, 71, 158, 79, 143, 327, 22, 490, 243, 310, 463, 295, 395, 276, 129, 85, 18, 76, -23, -117, 38, -52, -187, -156, -208, -21, -126, -198, -174, -74, -196, -78, -6, -137, -67, -59, -159, -243, -573, -16, 10, 154, 189, 173, 282, 425, 378, 357, 378, 86, 342, 285, 204, 113, 181, 106, 76, 97, -100, -121, -118, -155, -82, -5, -73, 153, -128, -107, -366, -91, -215, -249, -201, -170, -349, -213, -123, -12, -51, 31, 67, 149, 178, 233, 340, 175, 240, 260, 296, 85, -115, 268, 240, 202, 210, 170, 203, 207, -81, 335, 329, 307, 29, -95, -93, -11, -203, -117, -217, -388, -212, -191, -272, -225, -148, -110, -13, -263, 19, 147, 61, 105, 23, -159, -261, -438, -131, 180, 126, 204, 375, 299, 506, 371, 153, 415, 411, 197, 141, 16, 46, 95, 55, -77, -167, -134, -599, -118, -140, -142, -79, 35, -595, -220, -54, -255, -243, -375, -483, -199, -236, -68, -44, 124, 225, -64, 386, 353, 323, 291, 287, 184, 151, 231, 166, 259, 214, 294, 270, -233, 300, 204, 165, 133, -58, -103, -37, -16, 22, 58, 67, -68, -199, -160, -284, -254, -316, -172, -132, -29, -195, 2, 55, 101, -37, -16, 141, 120, 193, 172, 232, 247, 173, 169, 231, 278, 335, 263, -25, 278, 252, 186, 163, 172, 278, 169, 12, 17, 42, -212, -85, -290, -284, -353, -143, -298, -157, 35, -52, -148, -220, -209, -283, -167, -27, -39, 24, 106, 255, 260, 250, 126, 137, 92, 179, 223, 283, 325, 350, 231, 183, 210, 228, 239, 217, -172, 211, 82, -419, 104, 10, -22, -253, -241, -68, -137, -156, -28, -220, -177, -16, -149, -139, -108, -252, -16, -34, -124, 87, 83, 43, 282, 231, 234, 244, 297, 206, 246, -156, 258, 346, -355, 97, 476, 154, 251, 241, 132, 29, -67, -51, -661, -139, -130, -51, -166, -12, -751, -259, -126, -153, -91, -340, -146, -454, -374, -135, 21, -5, -13, 149, 189, 273, 332, 179, -205, 253, 326, 273, 145, 279, 326, 186, 172, 217, 326, 198, 117, -162, 111, 13, -491, -1, 13, -722, -219, -168, -140, -294, -273, -384, -363, -266, -97, -275, -65, -118, -62, -85, 134, -27, 2, -16, 16, 215, 119, 60, 92, 192, 229, 219, 388, 485, 479, 434, 450, 409, 418, 251, 285, -26, 90, -101, -78, -210, -212, -449, -403, -206, -206, -37, -244, -164, -651, -470, -291, -217, -214, -272, -320, -125, -76, -46, 1, 97, 5, 139, 277, 348, 257, -102, -62, 272, 276, 252, 220, 290, 333, 255, 197, 129, 340, 54, 130, 53, 48, 107, 96, -73, -439, -542, -27, -179, -351, -316, -188, -306, -278, -175, -271, -256, -471, 64, 22, 132, -6, 113, 72, 97, 101, -19, 107, 28, 219, 323, 223, 390, 9, 262, 358, 337, 309, 205, 116, 182, 69, -39, 138, -16, -3, -156, -8, -16, -235, -342, -140, -166, -245, -340, -197, 21, -175, -85, -164, 67, 129, 4, -74, -102, -58, 75, 47, 181, 125, 35, 73, 263, 367, 226, 258, 240, 354, 308, 281, 177, -442, 147, 10, 79, -3, 46, -91, -338, 106, -26, -86, -655, -225, 19, -116, -129, -183, -45, -249, -187, -39, -201, -294, 41, -64, 43, 242, 208, 162, 243, 41, 336, 478, 408, 338, 444, 299, 263, 215, -190, -47, 212, 107, 67, 79, -11, -45, -19, 84, -622, 59, -26, -78, -231, -67, -490, -255, -421, -263, -250, -353, -678, -513, -375, -358, -41, 247, -87, 267, 153, 169, 209, 127, 183, 249, 71, 31, -129, 122, 169, 378, 297, 557, -63, 293, 516, 199, 139, 23, -589, -156, -241, -260, -332, -308, -374, -214, -376, -245, -672, -38, 46, -115, 146, -28, 4, 62, -124, -35, -134, -239, -114, -82, 136, 279, 432, 364
    //[0.99609, 0.00000]

    //ON
    //34, 9, -33, -10, 33, 23, -11, 78, 2, -51, -210, -17, -30, -13, -3, -155, -13, -158, -150, -156, -106, -125, -92, -457, -117, 1, -100, 141, -145, 59, -4, 118, 22, -58, -132, 99, -394, -23, 190, 151, 292, 289, -225, 236, 314, 37, 157, 199, 165, 185, 143, 249, 151, 11, 12, 26, -496, -415, 52, -2, 169, 71, -236, 73, -51, -43, -422, 34, -70, -65, -713, -127, -130, 77, 79, 84, -73, 58, -16, 218, 58, 17, 43, 11, 11, -60, 109, 105, -68, 93, 26, 207, 94, 140, 201, 177, 250, 301, 316, 281, 316, 150, 129, 178, 97, -17, 119, 45, -64, 123, -51, 46, 47, 52, -57, -487, -38, -619, -78, -124, -60, -161, -213, -281, -195, -146, 75, -66, -35, 83, 60, 153, 73, 151, -90, -92, -117, -229, -16, 41, 138, 136, -270, 108, 19, 66, 90, 209, 187, 102, -131, 276, 123, 136, 86, 221, 114, 81, 71, 113, -264, 60, 76, 147, -136, -38, 95, 33, -319, -98, -22, 54, -139, -187, -212, -155, -343, -188, -186, -180, -273, -41, -2, 139, 157, 75, 191, 218, 167, -24, 3, 19, -16, 57, -8, -9, 149, 110, 218, 190, 159, 90, 225, 397, 200, 265, 44, 156, 74, 163, 27, -16, 57, -16, 63, -207, 45, 19, 105, 105, 144, 6, 47, 121, 10, -83, -129, -246, -833, -1007, -162, -115, -5, -39, -23, 91, 169, -5, 149, -40, 167, 94, 88, -196, 106, 75, 42, 58, -72, 132, 125, 153, 181, 313, 176, 258, 227, 297, 235, -68, 323, 206, 42, -85, -96, -16, -74, -247, -222, 147, -59, 81, 174, -51, 84, 137, -12, 1, -301, 36, -35, -537, -131, -79, -190, -547, -207, -382, 52, -512, -455, 167, 60, 140, 201, -10, 165, 106, 148, -43, -71, 149, 81, 9, 69, -134, 381, 246, 291, 253, 250, 269, 173, 226, 202, 55, -16, -491, -28, -108, -112, -30, 29, 1, 28, 113, 20, 63, 44, 101, 98, -16, -78, -265, -131, -78, -211, -786, -534, -678, 43, 20, 56, 6, 57, 143, 203, 154, 94, 135, 246, -16, 23, 51, -79, -25, -10, 91, 123, -437, -1, 314, 318, 214, 303, 153, -357, 241, 133, 107, -50, -85, -40, -499, -221, 27, 43, -49, -48, 119, 133, -265, 22, 55, 222, -16, -356, -119, -244, -279, -318, -179, -114, 13, 49, 77, 151, 279, 212, 163, 189, 148, 131, 104, 87, -28, -64, 21, -67, -382, 124, 219, 211, 366, 108, 337, 193, -111, 345, 363, 118, -228, 97, 100, -198, -115, 18, -91, -151, -126, -17, -2, 98, -17, 83, 55, 45, -70, -132, -77, -233, -238, -272, -267, -70, 27, -115, -3, 12, -127, -63, 169, 69, 197, 118, 17, -37, 46, 19, -513, 61, 161, 171, 158, 154, 110, 101, 292, 109, 322, 218, 167, -252, -387, 123, 45, -69, -24, -122, -38, -46, -203, -16, -179, -147, 123, 155, -33, -36, 21, -46, -82, -169, 47, -227, -153, -98, -160, -37, -252, 187, 143, 248, 123, 130, 186, 61, 121, 71, 85, 81, 108, 35, 11, 123, 253, 237, 151, 172, 167, 193, 249, 253, 195, 35, 217, -126, 118, 68, -90, -14, -57, -130, -53, -22, -16, -49, -484, -184, -590, -314, -370, -36, -16, -174, -91, -302, -160, -80, -169, -115, 17, -82, 106, 260, -46, 155, 286, 134, 81, -460, 52, 174, 203, -135, 165, -446, 4, 74, 163, 220, 277, 346, 261, 231, 371, 106, -16, 196, 171, -4, -47, -116, -71, -90, -150, 25, 106, -28, -58, -415, 53, 46, -247, -14, 89, -89, -191, -107, -181, -261, -103, 4, -27, 23, -114, 145, 121, 245, 104, 1554, -359, -549, 388, 178, 689, 330, -315, 257, -221, -108, -51, 77, -18, 460, -575, 323, 436, -67, -141, -117, 145, -388, -129, 323, -162, 37, 86, 130, -152, 23, 186, 190, -130, 93, -59, -5, -231, -190, -19, -55, 13, -19, -16, -34, -103, -378, -103, -42, -199, 141, 69, -183, -100, -306, -2, -64, 103, 252, 84, 238, -18, 50, 21, 19, 12, 53, 246, 146, 243, 163, 90, -76, 43, -16, 62, 12, -18, -29, -127, 47, 36, -55, -65, -5, -43, -21, -66, -91, 9, -143, 52, 16, -86, -58, -14, -29, -113, -16, -57, 5, -17, -25, 47, 5, 20, -46, 29, 30, 61, -16, 48, 100, 76, 34, -71, 43, 51, 94, 53, 20, 52, -16, 77, 64, 53, 92, 89, 126, 41, 45, 1, 19, -57, 19, -171, 15, 3, -2, -68, -27, -73, -60, -53, -10, 27, -28, -39, -34, -129, -113, -26, -109, 18, -67, -9, -21, 17, -21, -16, 12, 82, 50, 36, 50, 53, 69, 92, 83, 49, 82, 68, 53, 84, 27, 92, 68, 75, 75, 73, 68, 55, 54, 70, 46, 38, 15, -37, -16, -17, -50, -83, -39, -124, -27, -75, -13, -36, 11, -18, -31, -16, -41, -37, -51, -53, -74, -37, -60, -54, -16, -16, 13, -10, 49, 57, 61, 1, 71, 90, 46, 31, 76, 66, 52, 17, 58, 32, 31, 23, 36, 47, 47, 76, 92, 98, 106, 78, 69, 45, 44, -44, -5, -38, -21, -43, -70, -148, -57, -18, -39, -21, -16, -19, -15, -45, -33, -25, -37, -56, -31, -61, -28, -29, -22, -46, 22, 25, 15, 44, 52, -16, 57, 99, 91, 73, 87, 49, 22, 76, 55, 32, 27, 11, 36, 24, 53, 61, 61, 9, 78, 69, 64, 48, 37, -66, -10, -19, -42, -59, -63, -130, -65, -65, -139, -142, -35, -39, -16, -18, -18, -17, -52, -16, -51, -60, -37, -31, -32, -57, -28, 2, -3, 66, 35, 99, 125, 153, 131, 83, 117, 79, 97, 89, 90, 62, 63, 61, 18, 67, 85, 66, 78, 74, 92, 76, 52, 52, 35, -26, 19, -8, -12, -77, -61, -73, -65, -139, -85, -105, -35, -29, -47, -30, -34, -21, -39, -31, -84, -31, -30, -45, -63, -39, -118, -16, 69, 75, 105, 115, 89, 92, 121, 122, 130, 121, 113, 77, 61, 57, 39, 38, 36, 43, 17, 72, 42, -52, 47, 55, 63, 58, 10, 2, -16, -18, -50, -65, -91, -102, -95, -79, -95, -81, -61, -39, -36, -26, -16, 0, -122, 41, -43, 3, 23, -86, 47, -173, -149, -1379, 1300, 45, 1214, 125, -175, 98, 387, -37, 153, 169, 511, -140, -299, 361, 159, 506, 36, 267, 364, 253, 219, 53, -101, -44, -62, 173, 254, -246, -16, -549, -482, 21, -197, -81, -127, -51, 37, -187, 0, -267, -211, -15, -50, 99, 132, 198, 245, 170, -150, -33, -114, 148, 15, 49, 209, 84, 322, -44, -123, 275, 50, -39, 52, 130, 180, 85, 17, -14, 146, 155, -37, 207, 53, 37, 127, -141, 33, 94, 52, -16, 21, -41, -58, -146, -63, -51, 27, -22, 90, -80, -70, -61, 43, -57, -42, -28, 31, 72, 36, -18, 64, 29, 42, -16, 42, 81, 43, 83, 84, 83, 17, 124, 66, 90, 79, 165, 29, 46, 69, 45, 37, 30, 61, 73, 61, 0, -27, -17, 43, -27, 4, 29, -14, 46, -16, -60, -73, -51, -139, -50, -21, -105, -41, -96, -59, -27, -87, -51, 5, -16, -17, 7, 3, 3, -28, 24, 28, 20, 15, 4, 12, 4, 31, 37, 70, 100, 101, 81, 95, 123, 85, 95, 77, 78, 80, 74, 1, 39, -36, -71, 2, 31, 19, -10, -17, 5, 6, -5, -13, -7, 17, -4, -20, -17, -53, -33, -91, -107, -63, -92, -70, -48, -16, -20, -16, -11, -16, -4, 14, 1, -49, 4, 21, 54, 14, 1, 20, 42, 52, 12, 79, 99, 86, 57, 78, 113, 139, 124, 99, 116, 71, 67, 14, 32, 20, 7, -27, -15, 0, -9, 16, 4, 17, 4, -16, -16, -16, -6, -23, -43, -106, -98, -107, -111, -100, -65, -55, -57, -34, -28, -7, -2, 2, 22, 26, 9, 11, 28, 21, 11, -15, 4, 29, 39, 31, -23, 71, 123, 102, 102, 118, 118, 122, 57, -3, 74, 81, 55, 30, 23, -77, 2, -16, -16, 4, -5, -17, -19, -109, 6, -97, -52, -33, -32, -128, -89, -119, -92, -101, -78, -105, -107, -31, -43, -31, 15, 16, 25, 64, 53, 59, 44, 45, 50, 39, 52, 42, 38, 9, 46, 100, 75, 121, 122, 100, 107, 107, 21, 87, 131, 4, 70, 15, 5, -14, -33, -57, -59, -52, -121, -65, -57, -13, -11, -16, -18, -16, -29, -61, -78, -71, -74, -105, -83, -112, -27, -51, -51, -20, 34, 37, 59, 91, 92, 93, 143, 71, 78, 64, 75, 25, 70, 45, 53, 67, 60, 89, 102, 109, 121, 130, 146, 98, 53, 82, -69, -11, -44, -31, -49, -85, -89, -112, -105, -86, -61, -19, -11, -16, -16, -18, -52, -98, -61, -63, -78, -101, -71, -84, -80, -38, -23, -9, 41, 85, 94, 127, 127, 146, 123, 151, 125, 211, 457, -795, -1514, 985, 1542, 716, -165, -146, -48, 92, 797, 199, 198, 375, 294, -16, -516, 417, 180, -297, 147, 334, 40, 247, -46, -148, -234, -226, 131, 103, 10, -178, 15, -38, -275, -159, -63, 132, 41, -43, -2, 114, -172, -146, 174, 47, 94, 108, 33, 399, 172, -13, 100, 18, -115, 3, -66, 66, 239, 115, 303, 154, -125, -19, 70, 67, 25, 160, 146, 37, 76, 14, -5, -108, -129, 84, -15, 25, -127, -45, -206, -25, -23, -42, -164, 35, 67, -65, 87, -1, -14, 89, 59, 17, 30, -2, -42, 75, -70, 5, 51, 118, 165, 121, 91, 133, 53, -16, 92, 64, 136, 172, 89, 52, 37, 37, 54, 81, 100, 74, 29, 26, 45, -1, -16, 21, 22, -16, -34, -34, -142, -16, -51, -96, -4, -60, -17, -16, -93, -31, -42, -50, -16, -16, -7, -16, -57, -35, -33, 10, 2, 31, -16, -18, -28, 75, 57, 73, 99, 76, 78, 75, 69, 62, 50, -15, 44, 34, 59, 60, 70, 43, 34, 46, 67, 50, -12, 56, 2, 29, 1, -27, -34, -33, -46, -164, -65, -94, -44, -62, -33, -29, -1, -16, 12, -1, 33, -13, 9, -36, -12, -19, 4, 18, 13, -13, -7, 7, 42, 65, 98, 90, 86, 86, 110, 106, 97, 87, 76, 59, 35, -16, 47, 25, 62, 49, 41, 35, 28, 41, 39, -33, -14, 37, -7, 0, -21, -75, -47, -64, -70, -91, -134, -79, -59, -51, -37, -65, -54, -5, -16, -16, -101, -16, -16, -16, -17, -23, -14, 0, 12, 31, 44, 75, 86, 98, 59, 115, 116, 104, 120, 108, 81, 82, 53, 46, 26, 22, 37, 46, 44, 51, 51, 35, 46, 51, 25, 13, -9, -12, -15, -13, -67, -58, -163, -93, -74, -78, -78, -53, -16, -43, -20, -7, -10, 19, 21, 29, 9, -3, -39, -11, -4, 1, -65, -3, 81, 62, 81, 97, 103, 133, 105, 116, 121, 90, 100, 52, 50, -16, -69, -1, 10, 15, 3, 11, -49, 5, -89, 33, 34, 18, -16, -16, -35, -78, -81, -65, -75, -84, -84, -198, -70, -49, -52, -33, -33, -11, 15, 12, 19, -78, 5, 9, 23, 7, 9, 47, 40, 51, 52, 63, 86, 86, 14, 95, 151, 131, 115, 142, 85, 100, 81, 92, 60, 29, -10, 33, -5, -2, -7, -2, -29, -16, -15, -6, -16, -16, -31, -29, -54, -27, -78, -185, -126, -93, -99, -102, -78, -28, -16, 19, 26, 2, 22, -16, -6, 57, 25, 23, 14, 35, 38, 18, 14, 44, 47, 89, 58, 105, 116, 151, 147, 143, 92, 99, 139, 82, 47, 26, 3, -22, -32, -11, -19, -14, -17, -20, -59, -14, 1, -145, -3, -27, -57, -63, -86, -113, -227, -129, -94, -173, -65, -50, 10, 43, 68, 85, 100, 93, 103, 92, 70, 52, 62, -16, 29, 39, 30, 57, 66, 96, 93, 34, 99, 140, 126, 134, 133, 130, 63, 44, 25, -36, 1, -27, -69, -86, -221, -70, -49, -29, -16, -5, -73, 9, 32, -126, -1, -41, -81, -70, -91, -96, -84, -105, -61, -201, -16, 37, 63, 22, 43, 158, 115, 133, 108, 65, 90, -21, 10, 21, 26, 38, 45, 96, 52, 120, 132, 129, 94, 136, 57, 114, 21, -28, 26, 43, -16, -23, -60, -68, -101, -116, -98, -160, -10, -30, -16, -103, -3, 21, -19, -173, -70, -92, -143, -123, -143, -127, -67, 1, -18, 27, 25, 92, 112, 113, 140, 132, 119, 98, 85, 68, 130, 68, 75, 18, 85, 45, 76, -59, 121, 135, 139, 138, 142, 119, 68, 36, 21, -21, -52, -43, -234, -70, -72, -95, -69, -49, -43, -45, -10, 20, -13, 30, -183, -46, -27, -51, -84, -44, -54, -83, -83, -43, -9, -38, 68, 82, 43, 126, 161, 180, 62, 119, 82, -68, -45, 36, -16, 53, -1, 75, 70, 84, 49, 84, 125, 95, 105, 107, 82, -90, 34, -16, -17, -16, -189, -58, -130, -117, -50, -79, -25, -13, -58, 47, 5, -57, -18, 10, -13, -69, -89, -58, -75, -85, -235, -209, -186, 61, 117, 94, 108, 135, 171, 132, 183, 172, 119, 117, -6, 42, 59, 50, 70, 95, -16, 97, 74, 93, 63, -4, 91, 41, 38, 21, -16, -39, -154, -124, -90, -128, -147, -333, -89, -146, -97, -115, -16, -8, -38, -52, -28, -16, -11, -51, -58, -47, -41, -159, -6, -25, 83, 41, -42, 62, 157, 164, 147, 157, 186, 117, 109, 113, 82, 46, -16, 19, 20, -124, -125, 97, 116, -146, 89, 82, 99, -188, -16, -98, -134, -155, -205, -387, -186, -233, -213, -232, -166, -16, -16, -19, -37, -34, -28, 25, -33, -36, 7, -125, -71, -19, 19, 127, -16, -73, 130, 194, 269, 218, 223, 163, 158, 121, 80, 61, 62, -149, -213, -123, -306, 86, 106, 53, 66, 60, 100, 109, 57, -33, -116, -121, 5, -59, -132, -139, -97, -109, -27, -47, -50, 10, -66, 61, -13, 125, 67, 35, -21, -100, -183, -75, 4, 137, 228, 154, 89, 65, 63, 130, 185, 188, 177, 228, 226, 257, 212, 165, 93, 47, 31, -6, -66, -123, -127, -55, -50, -102, 53, -25, -29, 22, 67, 39, -99, -112, -15, 0, 41, 12, -189, -222, -188, -116, -75, 51, -16, 70, 98, 89, 141, 125, 32, -62, -15, -246, -25, 6, -44, -38, -17, 19, 111, 93, 80, 134, 172, 205, 191, 156, 215, 164, 153, -228, -278, -177, -51, -3, -16, 78, 93, -238, -175, 66, 134, 104, 69, -16, -162, -45, -16, -109, -237, -163, -209, -195, -124, -438, -14, 58, 121, -16, -16, 22, 123, 7, -229, -16, -78, -166, -155, -35, 82, 93, 94, 102, 179, 214, 321, 247, 215, 171, 67, 61, 68, 133, -271, -196, -435, -151, -60, 102, -124, 83, 44, 128, 228, 65, 93, 10, -33, -340, -288, -562, -315, -239, -270, -167, -268, -181, -98, -18, 129, 222, 219, 131, 69, 136, -9, -361, 47, -5, -413, 26, -2, -233, 221, 327, 241, 298, 126, 292, 272, 359, 241, 135, -315, -358, -20, -81, -23, -71, -6, -50, 29, 138, 58, 2, -16, -136, -349, 6, -29, 80, -68, -119, -215, -268, -374, -362, -83, -36, -16, 124, 143, 201, 159, 248, 193, 153, -20, 89, -74, -50, 43, 124, -2, 13, 99, -22, -213, 245, 162, 238, -83, 350, 211, 170, 100, -16, 95, -85, -123, -128, -153, -211, -141, -62, 62, 266, 90, 109, -1, 4, 68, -12, -35, -150, -73, -206, -159, -90, -110, -54, -26, 59, 150, 153, 178, 256, 163, 158, 202, 182, 95, 17, -141, -239, 104, -43, 45, -46, 3, -215, 286, 203, 284, 135, 175, 50, 137, -177, 6, -96, -379, -66, -16, -38, -167, -217, -45, 19, 22, -108, 67, 55, 108, 98, 21, 19, -131, -54, -287, -290, -220, -58, -110, -7, 279, 222, 224, 99, 254, 287, 163, 201, -254, 125, 114, 79, 109, 263, 31, 15, 6, -176, 18, 286, -52, 97, 306, 316, 97, 77, 53, 164, -314, -91, -538, -65, 19, -194, -112, -33, -155, -45, 5, -30, -37, -92, 149, 87, 165, -25, 3, -169, -171, -86, -116, -38, 54, 100, 145, 59, 241, -20, 162, 192, 322, 178, 150, 266, 167, 149, 61, 63, 61, 86, 45, -474, 262, 101, -16, 114, 181, 115, 225, 188, 229, 52, -45, 145, -75, -6, -49
    //[0.00000, 0.99609]
};
  
int raw_feature_get_data(size_t offset, size_t length, float * out_ptr) {
    memcpy(out_ptr, features + offset, length * sizeof(float));
    return 0;
}


int main(void) {
    // initialize stdio and wait for USB CDC connect
    stdio_init_all();


    printf("connected\n");

    ei_impulse_result_t result = {
        nullptr
    };

    ei_printf("Edge Impulse standalone inferencing (Raspberry Pi Pico)\n");

    // initialize the analog microphone
    if (analog_microphone_init( & config) < 0) {
        ei_printf("analog microphone initialization failed!\n");
        while (1) {
            tight_loop_contents();
        }
    }

    // set callback that is called when all the samples in the library
    // internal sample buffer are ready for reading
    analog_microphone_set_samples_ready_handler(on_analog_samples_ready);

    // start capturing data from the analog microphone
    if (analog_microphone_start() < 0) {
        ei_printf("Analog microphone start failed!\n");
        while (1) {
            tight_loop_contents();
        }
    }


    //if (sizeof(features) / sizeof(float) != EI_CLASSIFIER_DSP_INPUT_FRAME_SIZE)
    //{
    //  ei_printf("The size of your 'features' array is not correct. Expected %d items, but had %u\n",
    //            EI_CLASSIFIER_DSP_INPUT_FRAME_SIZE, sizeof(features) / sizeof(float));
    //  return 1;
    //}
    
    while (1) {
        // wait for new samples
        while (samples_read == 0) {
            tight_loop_contents();
        }

        // store and clear the samples read from the callback
        int sample_count = samples_read;
        samples_read = 0;
        //printf("sample_count returned: %d\n", sample_count);

        // loop through any new collected samples
        for (int i = 0; i < sample_count; i++) { //sample_count returned: 16
            features[i] = (float)sample_buffer[i];
            //printf("%f \n", (float)sample_buffer[i]);
        }

        //printf("size of features/floats: %d\n", sizeof(features) / sizeof(float));
        //printf("EI_CLASSIFIER_DSP_INPUT_FRAME_SIZE: %.3f\n", EI_CLASSIFIER_DSP_INPUT_FRAME_SIZE);
        //printf("EI_CLASSIFIER_RAW_SAMPLES_PER_FRAME: %.3f\n", EI_CLASSIFIER_RAW_SAMPLES_PER_FRAME);
        //printf("size of features returned: %d\n", sizeof(features));
        //printf("total_length: %d\n", sizeof(features) / sizeof(features[0]));

        //sample_count returned: 16
        //size of features/floats: 2700
        //EI_CLASSIFIER_DSP_INPUT_FRAME_SIZE: 0.000
        //EI_CLASSIFIER_RAW_SAMPLES_PER_FRAME: 0.000
        //size of features returned: 10800
        //total_length: 2700
        //run_classifier returned: 0


        // the features are stored into flash, and we don't want to load everything into RAM
        signal_t features_signal;
        features_signal.total_length = sizeof(features) / sizeof(features[0]);
        features_signal.get_data = &raw_feature_get_data;


        // invoke the impulse
        EI_IMPULSE_ERROR res = run_classifier(&features_signal, &result, false);

        //ei_printf("run_classifier returned: %d\n", res);

        if (res != 0)
            return 1;

        ei_printf("Predictions (DSP: %d ms., Classification: %d ms., Anomaly: %d ms.): \n",
            result.timing.dsp, result.timing.classification, result.timing.anomaly);

        // print the predictions
        ei_printf("[");
        for (size_t ix = 0; ix < EI_CLASSIFIER_LABEL_COUNT; ix++) {
            ei_printf("%.5f\n", result.classification[ix].value);

            if (ix == 1 && result.classification[ix].value > thresh) {
              count_label_on++;
            } else {
              //count_label_on = 0;
            }

            if (result.classification[0].value > result.classification[1].value) {
              count_label_on = 0;
            }

            if (count_label_on >= threshold) {
              std::time_t current_time = std::time(0);
              if (current_time - start_time >= minutes * 60) {
                printf("FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF\n");
                count_label_on = 0;
                start_time = std::time(0);
              }
            } 

            #if EI_CLASSIFIER_HAS_ANOMALY == 1
            ei_printf(", ");
            #else
            if (ix != EI_CLASSIFIER_LABEL_COUNT - 1) {
                ei_printf(", ");
            }
            #endif
        }
        #if EI_CLASSIFIER_HAS_ANOMALY == 1
        printf("%.3f", result.anomaly);
        #endif
        printf("]\n");
        
        

        //sleep_ms(2000);

    }

    return 0;
}
